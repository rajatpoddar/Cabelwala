{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-gray-50 flex">
    {% include 'admin/sidebar.html' %}
    <div class="flex-1 overflow-auto p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Generate New Bill</h2>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-5xl">
            <form action="{{ url_for('admin.create_invoice') }}" method="POST">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Select Client</label>
                        <select name="client_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                            <option value="">-- Choose Client --</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.name }} ({{ client.mobile }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bill For</label>
                            <select name="bill_for" id="billForSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white" onchange="toggleRechargeOptions()">
                                <option value="INTERNET RECHARGE">Internet Recharge</option>
                                <option value="CCTV INSTALLATION">CCTV Installation</option>
                                <option value="FIBER CONNECTION">New Fiber</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Payment Status</label>
                            <select name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                                <option value="Unpaid">Unpaid</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="rechargePeriodBox" class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                    <label class="block text-sm font-medium text-blue-800 mb-2"><i class="fas fa-calendar-alt mr-1"></i> Recharge Period</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs text-gray-500">From Month</span>
                            <input type="month" id="period_from" class="block w-full rounded-md border-blue-300 shadow-sm sm:text-sm p-2 border" onchange="updateFirstRow()">
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">To Month</span>
                            <input type="month" id="period_to" class="block w-full rounded-md border-blue-300 shadow-sm sm:text-sm p-2 border" onchange="updateFirstRow()">
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-2 border-b pb-2 mt-4">
                    <h3 class="text-lg font-semibold text-gray-800">Bill Items</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">Quick Add Plan:</span>
                        <select id="planSelect" class="rounded border-gray-300 text-sm p-1" onchange="addPlanToTable()">
                            <option value="">-- Select Plan --</option>
                            {% for plan in plans %}
                                <option value="{{ plan.price }}" data-name="{{ plan.name }}">{{ plan.name }} - ₹{{ plan.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto mb-6">
                    <table class="min-w-full divide-y divide-gray-200" id="itemsTable">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Qty</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-32">Price (₹)</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-32">Total (₹)</th>
                                <th class="px-4 py-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody" class="divide-y divide-gray-100">
                            <tr class="item-row">
                                <td class="px-2 py-2"><input type="text" name="description[]" required class="w-full border-gray-300 rounded p-1" placeholder="e.g. CNET DIAMOND"></td>
                                <td class="px-2 py-2"><input type="number" name="quantity[]" value="1" min="1" class="w-full border-gray-300 rounded p-1 qty-input" oninput="calculateRow(this)"></td>
                                <td class="px-2 py-2"><input type="number" name="price[]" value="0" step="0.01" class="w-full border-gray-300 rounded p-1 price-input" oninput="calculateRow(this)"></td>
                                <td class="px-2 py-2"><input type="text" readonly class="w-full bg-gray-50 border-transparent text-gray-700 font-medium rounded p-1 row-total" value="0.00"></td>
                                <td class="px-2 py-2 text-center"><button type="button" onclick="removeRow(this)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" onclick="addRow()" class="mt-3 text-sm text-blue-600 font-medium hover:underline"><i class="fas fa-plus"></i> Add New Row</button>
                </div>

                <div class="flex justify-end border-t pt-4">
                    <div class="w-64 space-y-3">
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Subtotal:</span>
                            <span id="subtotalDisplay" class="font-medium">₹0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Tax Amount:</span>
                            <input type="number" id="taxInput" name="tax" value="0" min="0" step="0.01" class="w-24 border-gray-300 rounded p-1 text-right" oninput="calculateGrandTotal()">
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold text-gray-900 border-t pt-2">
                            <span>Grand Total:</span>
                            <span id="grandTotalDisplay">₹0.00</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md shadow hover:bg-blue-700">Generate Professional Invoice</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    window.currentPlanName = ""; // Store plan name globally

    // Row Calculation
    function calculateRow(element) {
        let row = element.closest('.item-row');
        let qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        let price = parseFloat(row.querySelector('.price-input').value) || 0;
        row.querySelector('.row-total').value = (qty * price).toFixed(2);
        calculateGrandTotal();
    }

    // Grand Total Calculation
    function calculateGrandTotal() {
        let subtotal = 0;
        document.querySelectorAll('.row-total').forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        document.getElementById('subtotalDisplay').innerText = "₹" + subtotal.toFixed(2);
        
        let tax = parseFloat(document.getElementById('taxInput').value) || 0;
        let grandTotal = subtotal + tax;
        document.getElementById('grandTotalDisplay').innerText = "₹" + grandTotal.toFixed(2);
    }

    // Dynamic Row Addition
    function addRow(desc = "", price = 0) {
        let tbody = document.getElementById('itemsBody');
        let tr = document.createElement('tr');
        tr.className = "item-row";
        tr.innerHTML = `
            <td class="px-2 py-2"><input type="text" name="description[]" value="${desc}" required class="w-full border-gray-300 rounded p-1"></td>
            <td class="px-2 py-2"><input type="number" name="quantity[]" value="1" min="1" class="w-full border-gray-300 rounded p-1 qty-input" oninput="calculateRow(this)"></td>
            <td class="px-2 py-2"><input type="number" name="price[]" value="${price}" step="0.01" class="w-full border-gray-300 rounded p-1 price-input" oninput="calculateRow(this)"></td>
            <td class="px-2 py-2"><input type="text" readonly class="w-full bg-gray-50 border-transparent text-gray-700 font-medium rounded p-1 row-total" value="${price.toFixed(2)}"></td>
            <td class="px-2 py-2 text-center"><button type="button" onclick="removeRow(this)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
        calculateGrandTotal();
    }

    function removeRow(button) {
        let row = button.closest('tr');
        if (document.querySelectorAll('.item-row').length > 1) {
            row.remove();
            calculateGrandTotal();
        } else {
            alert("At least one item is required.");
        }
    }

    // Toggle Period Block
    function toggleRechargeOptions() {
        let billFor = document.getElementById('billForSelect').value;
        let rechargeBox = document.getElementById('rechargePeriodBox');
        if (billFor === 'INTERNET RECHARGE') {
            rechargeBox.style.display = 'block';
        } else {
            rechargeBox.style.display = 'none';
        }
        updateFirstRow();
    }

    // Automatically build the string "PLAN NAME - FROM TO TO" for the first row
    function updateFirstRow() {
        let billFor = document.getElementById('billForSelect').value;
        let firstRowDesc = document.querySelector('.item-row input[name="description[]"]');
        let firstRowQty = document.querySelector('.item-row .qty-input');
        
        let baseName = window.currentPlanName || "";
        
        if (billFor === 'INTERNET RECHARGE') {
            let fromVal = document.getElementById('period_from').value;
            let toVal = document.getElementById('period_to').value;
            
            if (fromVal && toVal) {
                let fromDate = new Date(fromVal + '-01');
                let toDate = new Date(toVal + '-01');
                
                let monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                let fromStr = monthNames[fromDate.getMonth()] + " " + fromDate.getFullYear().toString().slice(-2);
                let toStr = monthNames[toDate.getMonth()] + " " + toDate.getFullYear().toString().slice(-2);
                
                let months = (toDate.getFullYear() - fromDate.getFullYear()) * 12;
                months -= fromDate.getMonth();
                months += toDate.getMonth();
                months = months <= 0 ? 1 : months + 1;
                
                firstRowQty.value = months;
                firstRowDesc.value = (baseName ? baseName + " - " : "RECHARGE - ") + fromStr + " TO " + toStr;
                calculateRow(firstRowQty);
            } else if (baseName) {
                firstRowDesc.value = baseName;
            }
        } else {
            if (baseName) {
                firstRowDesc.value = baseName;
            }
        }
    }

    // Triggered when a plan is selected from dropdown
    function addPlanToTable() {
        let select = document.getElementById('planSelect');
        let selected = select.options[select.selectedIndex];
        
        if (selected.value) {
            let price = parseFloat(selected.value);
            window.currentPlanName = selected.getAttribute('data-name');
            
            let firstRowPrice = document.querySelector('.item-row .price-input');
            firstRowPrice.value = price;
            
            updateFirstRow();
            calculateRow(firstRowPrice);
            select.value = ""; // Reset dropdown
        }
    }

    // On Load Check
    window.onload = function() {
        toggleRechargeOptions();
    };
</script>
{% endblock %}