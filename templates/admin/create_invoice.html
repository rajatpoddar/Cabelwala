{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-gray-50 flex">
    {% include 'admin/sidebar.html' %}
    
    <div class="flex-1 overflow-auto p-4 md:p-8 w-full max-w-full">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-extrabold text-gray-800">Generate New Bill</h2>
        </div>

        <div class="bg-white p-5 md:p-8 rounded-2xl shadow-sm border border-gray-100 max-w-5xl">
            <form action="{{ url_for('admin.create_invoice') }}" method="POST">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Select Client</label>
                        <select name="client_id" required class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3.5 border focus:bg-white focus:ring-2 focus:ring-blue-500 transition outline-none appearance-none">
                            <option value="">-- Choose Client --</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.name }} ({{ client.mobile }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Bill For</label>
                        <select name="bill_for" id="billForSelect" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3.5 border focus:bg-white focus:ring-2 focus:ring-blue-500 transition outline-none appearance-none" onchange="toggleRechargeOptions()">
                            <option value="INTERNET RECHARGE">Internet Recharge</option>
                            <option value="FIBER CONNECTION">New Fiber</option>
                            <option value="CCTV INSTALLATION">CCTV Installation</option>
                            <option value="CCTV MAINTENANCE">CCTV Maintenance</option> 
                            <option value="CAMERA & ACCESSORIES">Camera & Accessories Sale</option>
                            <option value="NETWORKING PRODUCTS">Networking Products Sale</option>
                            <option value="CABLE & WIRES">Cable & Wires Sale</option>
                            <option value="PRODUCT SALE">General Product Sale</option>
                            <option value="OTHER SERVICES">Other Services</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Payment Status</label>
                        <select name="status" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3.5 border focus:bg-white focus:ring-2 focus:ring-green-500 transition outline-none appearance-none font-bold text-gray-700">
                            <option value="Unpaid" class="text-red-600">Unpaid</option>
                            <option value="Paid" class="text-green-600">Paid</option>
                        </select>
                    </div>

                    <div class="md:col-span-3 flex items-center bg-blue-50 p-3 rounded-xl border border-blue-200">
                        <label class="inline-flex items-center cursor-pointer mr-4">
                            <input type="checkbox" name="is_gst_bill" id="is_gst_bill" class="sr-only peer" onchange="toggleGstMode()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-3 text-sm font-bold text-gray-700">Generate GST Invoice</span>
                        </label>
                        
                        <select id="default_gst_rate" class="hidden rounded-lg border-gray-300 bg-white p-2 text-sm font-bold focus:ring-blue-500 outline-none" onchange="applyDefaultGst()">
                            <option value="0">0% GST</option>
                            <option value="5">5% GST</option>
                            <option value="12">12% GST</option>
                            <option value="18" selected>18% GST</option>
                            <option value="28">28% GST</option>
                        </select>
                    </div>
                </div>

                <div id="rechargePeriodBox" class="bg-blue-50/50 p-5 rounded-2xl border border-blue-100 mb-6 transition-all">
                    <label class="block text-sm font-bold text-blue-800 mb-3"><i class="fas fa-calendar-alt mr-2"></i> Recharge Period</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-[10px] font-extrabold uppercase text-gray-500 block mb-1">From Month</span>
                            <input type="month" id="period_from" class="block w-full rounded-xl border-blue-200 bg-white p-3 border focus:ring-2 focus:ring-blue-500 transition outline-none" onchange="updateFirstRow()">
                        </div>
                        <div>
                            <span class="text-[10px] font-extrabold uppercase text-gray-500 block mb-1">To Month</span>
                            <input type="month" id="period_to" class="block w-full rounded-xl border-blue-200 bg-white p-3 border focus:ring-2 focus:ring-blue-500 transition outline-none" onchange="updateFirstRow()">
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 mt-8 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-3 sm:mb-0 px-2">Bill Items</h3>
                    <div class="flex items-center w-full sm:w-auto bg-white rounded-lg border border-gray-200 p-1">
                        <span class="text-xs text-gray-500 font-bold uppercase px-3 whitespace-nowrap">Quick Add</span>
                        <select id="planSelect" class="w-full sm:w-48 rounded-md border-0 bg-transparent py-2 pl-2 pr-8 text-sm font-bold text-blue-700 focus:ring-0 outline-none appearance-none" onchange="addPlanToTable()">
                            <option value="">-- Select a Plan --</option>
                            {% for plan in plans %}
                                <option value="{{ plan.price }}" data-name="{{ plan.name }}">{{ plan.name }} - ₹{{ plan.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div id="itemsBody" class="space-y-4">
                    <div class="item-row relative bg-white p-4 md:p-5 rounded-2xl border border-gray-200 shadow-sm transition-all hover:border-blue-300">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                            
                            <div class="md:col-span-4">
                                <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">Item Description</label>
                                <input type="text" name="description[]" required class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-gray-800" placeholder="e.g. CNET DIAMOND">
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:col-span-5">
                                <div class="gst-field hidden">
                                    <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">HSN/SAC</label>
                                    <input type="text" name="hsn_code[]" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800" placeholder="HSN">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">Quantity</label>
                                    <input type="number" name="quantity[]" value="1" min="1" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-center qty-input" oninput="calculateRow(this)">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">Price (₹)</label>
                                    <input type="number" name="price[]" value="0" step="0.01" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-center price-input" oninput="calculateRow(this)">
                                </div>
                                <div class="gst-field hidden">
                                    <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">GST %</label>
                                    <input type="number" name="gst_rate[]" value="18" min="0" max="100" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-center gst-input" oninput="calculateRow(this)">
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between md:col-span-3 bg-gray-50 p-2 rounded-xl border border-gray-100">
                                <div class="w-full text-center px-2">
                                    <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-0.5">Total</label>
                                    <input type="text" readonly class="w-full bg-transparent border-none text-blue-700 font-black text-lg p-0 text-center row-total outline-none" value="0.00">
                                </div>
                                <button type="button" onclick="removeRow(this)" class="w-10 h-10 flex-shrink-0 bg-red-50 text-red-500 hover:bg-red-100 rounded-lg flex items-center justify-center transition">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addRow()" class="mt-4 w-full md:w-auto bg-blue-50 text-blue-700 font-bold py-3.5 px-6 rounded-xl border border-blue-100 hover:bg-blue-100 transition flex justify-center items-center shadow-sm">
                    <i class="fas fa-plus-circle mr-2 text-lg"></i> Add Another Item
                </button>

                <div class="flex flex-col md:flex-row md:justify-end border-t border-gray-100 mt-8 pt-6">
                    <div class="w-full md:w-80 space-y-4 bg-gray-50/50 p-5 rounded-2xl border border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-500 uppercase">Subtotal:</span>
                            <span id="subtotalDisplay" class="font-bold text-gray-800 text-lg">₹0.00</span>
                        </div>
                        
                        <div id="gstTotalsDisplay" class="hidden space-y-2 border-t border-gray-200 pt-3 mt-2">
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-bold text-gray-500 uppercase">CGST:</span>
                                <span id="cgstDisplay" class="font-bold text-gray-800">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-bold text-gray-500 uppercase">SGST:</span>
                                <span id="sgstDisplay" class="font-bold text-gray-800">₹0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center border-t border-gray-200 pt-3 mt-2">
                            <span class="text-sm font-bold text-gray-500 uppercase">Other Charges (₹):</span>
                            <input type="number" id="taxInput" name="tax" value="0" min="0" step="0.01" class="w-28 border-gray-300 bg-white rounded-lg p-2 text-right font-bold focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" oninput="calculateGrandTotal()">
                        </div>
                        
                        <div class="flex justify-between items-center border-t border-gray-200 pt-4 mt-2">
                            <span class="text-base font-black text-gray-900 uppercase">Grand Total:</span>
                            <span id="grandTotalDisplay" class="text-2xl font-black text-blue-700">₹0.00</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-black text-lg py-4 px-4 rounded-2xl shadow-lg hover:shadow-xl hover:from-blue-700 hover:to-indigo-800 transition transform hover:-translate-y-0.5">
                        <i class="fas fa-file-invoice mr-2"></i> Generate Professional Bill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    window.currentPlanName = ""; 

    function toggleGstMode() {
        let isGst = document.getElementById('is_gst_bill').checked;
        document.getElementById('default_gst_rate').classList.toggle('hidden', !isGst);
        
        document.querySelectorAll('.gst-field').forEach(field => {
            field.classList.toggle('hidden', !isGst);
        });
        
        document.getElementById('gstTotalsDisplay').classList.toggle('hidden', !isGst);
        
        if(isGst) applyDefaultGst();
        calculateGrandTotal();
    }

    function applyDefaultGst() {
        let defaultRate = document.getElementById('default_gst_rate').value;
        document.querySelectorAll('.gst-input').forEach(input => {
            input.value = defaultRate;
            calculateRow(input);
        });
    }

    function calculateRow(element) {
        let row = element.closest('.item-row');
        let qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        let price = parseFloat(row.querySelector('.price-input').value) || 0;
        
        let isGst = document.getElementById('is_gst_bill').checked;
        let gstRate = isGst ? (parseFloat(row.querySelector('.gst-input').value) || 0) : 0;
        
        let baseTotal = qty * price;
        let gstAmount = baseTotal * (gstRate / 100);
        
        row.querySelector('.row-total').value = (baseTotal + gstAmount).toFixed(2);
        calculateGrandTotal();
    }

    function calculateGrandTotal() {
        let subtotal = 0;
        let totalCgst = 0;
        let totalSgst = 0;
        let isGst = document.getElementById('is_gst_bill').checked;

        document.querySelectorAll('.item-row').forEach(row => {
            let qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            let price = parseFloat(row.querySelector('.price-input').value) || 0;
            let baseTotal = qty * price;
            subtotal += baseTotal;

            if(isGst) {
                let gstRate = parseFloat(row.querySelector('.gst-input').value) || 0;
                let gstAmount = baseTotal * (gstRate / 100);
                totalCgst += gstAmount / 2;
                totalSgst += gstAmount / 2;
            }
        });

        document.getElementById('subtotalDisplay').innerText = "₹" + subtotal.toFixed(2);
        
        if(isGst) {
            document.getElementById('cgstDisplay').innerText = "₹" + totalCgst.toFixed(2);
            document.getElementById('sgstDisplay').innerText = "₹" + totalSgst.toFixed(2);
        }
        
        let tax = parseFloat(document.getElementById('taxInput').value) || 0;
        let grandTotal = subtotal + totalCgst + totalSgst + tax;
        document.getElementById('grandTotalDisplay').innerText = "₹" + grandTotal.toFixed(2);
    }

    function addRow(desc = "", price = 0) {
        let tbody = document.getElementById('itemsBody');
        let div = document.createElement('div');
        div.className = "item-row relative bg-white p-4 md:p-5 rounded-2xl border border-gray-200 shadow-sm transition-all hover:border-blue-300 mt-4";
        
        let isGst = document.getElementById('is_gst_bill').checked;
        let defaultRate = document.getElementById('default_gst_rate').value;
        let gstHiddenClass = isGst ? "" : "hidden";
        
        div.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                <div class="md:col-span-4">
                    <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">Item Description</label>
                    <input type="text" name="description[]" value="${desc}" required class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-gray-800" placeholder="e.g. Router config">
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:col-span-5">
                    <div class="gst-field ${gstHiddenClass}">
                        <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">HSN/SAC</label>
                        <input type="text" name="hsn_code[]" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800" placeholder="HSN">
                    </div>
                    <div>
                        <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">Quantity</label>
                        <input type="number" name="quantity[]" value="1" min="1" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-center qty-input" oninput="calculateRow(this)">
                    </div>
                    <div>
                        <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">Price (₹)</label>
                        <input type="number" name="price[]" value="${price}" step="0.01" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-center price-input" oninput="calculateRow(this)">
                    </div>
                    <div class="gst-field ${gstHiddenClass}">
                        <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-1.5">GST %</label>
                        <input type="number" name="gst_rate[]" value="${defaultRate}" min="0" max="100" class="block w-full rounded-xl border-gray-200 bg-gray-50 p-3 border focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold text-center gst-input" oninput="calculateRow(this)">
                    </div>
                </div>
                
                <div class="flex items-center justify-between md:col-span-3 bg-gray-50 p-2 rounded-xl border border-gray-100">
                    <div class="w-full text-center px-2">
                        <label class="block text-[10px] font-extrabold text-gray-400 uppercase tracking-wide mb-0.5">Total</label>
                        <input type="text" readonly class="w-full bg-transparent border-none text-blue-700 font-black text-lg p-0 text-center row-total outline-none" value="${price.toFixed(2)}">
                    </div>
                    <button type="button" onclick="removeRow(this)" class="w-10 h-10 flex-shrink-0 bg-red-50 text-red-500 hover:bg-red-100 rounded-lg flex items-center justify-center transition">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        `;
        tbody.appendChild(div);
        
        calculateRow(div.querySelector('.price-input'));
    }

    function removeRow(button) {
        let row = button.closest('.item-row');
        if (document.querySelectorAll('.item-row').length > 1) {
            row.remove();
            calculateGrandTotal();
        } else {
            alert("At least one item is required to generate a bill.");
        }
    }

    function toggleRechargeOptions() {
        let billFor = document.getElementById('billForSelect').value;
        let rechargeBox = document.getElementById('rechargePeriodBox');
        if (billFor === 'INTERNET RECHARGE') {
            rechargeBox.style.display = 'block';
        } else {
            rechargeBox.style.display = 'none';
        }
        updateFirstRow();
    }

    function updateFirstRow() {
        let billFor = document.getElementById('billForSelect').value;
        let firstRowDesc = document.querySelector('.item-row input[name="description[]"]');
        let firstRowQty = document.querySelector('.item-row .qty-input');
        
        let baseName = window.currentPlanName || "";
        
        if (billFor === 'INTERNET RECHARGE') {
            let fromVal = document.getElementById('period_from').value;
            let toVal = document.getElementById('period_to').value;
            
            if (fromVal && toVal) {
                let fromDate = new Date(fromVal + '-01');
                let toDate = new Date(toVal + '-01');
                
                let monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                let fromStr = monthNames[fromDate.getMonth()] + " " + fromDate.getFullYear().toString().slice(-2);
                let toStr = monthNames[toDate.getMonth()] + " " + toDate.getFullYear().toString().slice(-2);
                
                let months = (toDate.getFullYear() - fromDate.getFullYear()) * 12;
                months -= fromDate.getMonth();
                months += toDate.getMonth();
                months = months <= 0 ? 1 : months + 1;
                
                firstRowQty.value = months;
                firstRowDesc.value = (baseName ? baseName + " - " : "RECHARGE - ") + fromStr + " TO " + toStr;
                calculateRow(firstRowQty);
            } else if (baseName) {
                firstRowDesc.value = baseName;
            }
        } else {
            if (baseName) {
                firstRowDesc.value = baseName;
            }
        }
    }

    function addPlanToTable() {
        let select = document.getElementById('planSelect');
        let selected = select.options[select.selectedIndex];
        
        if (selected.value) {
            let price = parseFloat(selected.value);
            window.currentPlanName = selected.getAttribute('data-name');
            
            let firstRowPrice = document.querySelector('.item-row .price-input');
            firstRowPrice.value = price;
            
            updateFirstRow();
            calculateRow(firstRowPrice);
            select.value = ""; 
        }
    }

    window.onload = function() {
        toggleRechargeOptions();
    };
</script>
{% endblock %}