{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-gray-50 flex">
    {% include 'admin/sidebar.html' %}
    <div class="flex-1 overflow-auto p-4 md:p-8 w-full max-w-full">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Generate New Bill</h2>

        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 max-w-5xl">
            <form action="{{ url_for('admin.create_invoice') }}" method="POST">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Select Client</label>
                        <select name="client_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Choose Client --</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.name }} ({{ client.mobile }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bill For</label>
                            <select name="bill_for" id="billForSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white focus:ring-blue-500" onchange="toggleRechargeOptions()">
                                <option value="INTERNET RECHARGE">Internet Recharge</option>
                                <option value="CCTV INSTALLATION">CCTV Installation</option>
                                <option value="FIBER CONNECTION">New Fiber</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Payment Status</label>
                            <select name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white focus:ring-blue-500">
                                <option value="Unpaid">Unpaid</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="rechargePeriodBox" class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                    <label class="block text-sm font-medium text-blue-800 mb-2"><i class="fas fa-calendar-alt mr-1"></i> Recharge Period</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs text-gray-500">From Month</span>
                            <input type="month" id="period_from" class="block w-full rounded-md border-blue-300 shadow-sm sm:text-sm p-2 border focus:ring-blue-500 focus:border-blue-500" onchange="updateFirstRow()">
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">To Month</span>
                            <input type="month" id="period_to" class="block w-full rounded-md border-blue-300 shadow-sm sm:text-sm p-2 border focus:ring-blue-500 focus:border-blue-500" onchange="updateFirstRow()">
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 border-b pb-2 mt-4 space-y-2 md:space-y-0">
                    <h3 class="text-lg font-semibold text-gray-800">Bill Items</h3>
                    <div class="flex items-center space-x-2 bg-gray-50 p-2 rounded w-fit">
                        <span class="text-sm text-gray-600 font-medium">Quick Add Plan:</span>
                        <select id="planSelect" class="rounded border-gray-300 text-sm p-1.5 focus:ring-blue-500" onchange="addPlanToTable()">
                            <option value="">-- Select Plan --</option>
                            {% for plan in plans %}
                                <option value="{{ plan.price }}" data-name="{{ plan.name }}">{{ plan.name }} - ₹{{ plan.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="w-full mb-6">
                    <div class="hidden md:grid grid-cols-12 gap-2 font-bold text-gray-500 text-xs uppercase mb-3 px-2">
                        <div class="col-span-5">Description</div>
                        <div class="col-span-2">Qty</div>
                        <div class="col-span-2">Price (₹)</div>
                        <div class="col-span-2">Total (₹)</div>
                        <div class="col-span-1 text-center"></div>
                    </div>

                    <div id="itemsBody" class="space-y-4 md:space-y-2">
                        <div class="item-row relative bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-lg border md:border-0 border-gray-200 grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-2 items-center">
                            
                            <div class="md:col-span-5">
                                <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Item Description</label>
                                <input type="text" name="description[]" required class="w-full border-gray-300 rounded md:p-1.5 p-2 shadow-sm md:shadow-none bg-white focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. CNET DIAMOND">
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 md:contents">
                                <div class="md:col-span-2">
                                    <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Qty</label>
                                    <input type="number" name="quantity[]" value="1" min="1" class="w-full border-gray-300 rounded md:p-1.5 p-2 qty-input focus:ring-blue-500 bg-white" oninput="calculateRow(this)">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Price (₹)</label>
                                    <input type="number" name="price[]" value="0" step="0.01" class="w-full border-gray-300 rounded md:p-1.5 p-2 price-input focus:ring-blue-500 bg-white" oninput="calculateRow(this)">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Total (₹)</label>
                                    <input type="text" readonly class="w-full bg-gray-200 md:bg-gray-100 border-transparent text-gray-800 font-semibold rounded md:p-1.5 p-2 row-total" value="0.00">
                                </div>
                            </div>
                            
                            <div class="md:col-span-1 absolute md:static top-2 right-2 md:text-center text-right">
                                <button type="button" onclick="removeRow(this)" class="text-red-500 hover:text-red-700 bg-red-100 md:bg-transparent p-2 md:p-1 rounded-md transition"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" onclick="addRow()" class="mt-4 text-sm text-blue-600 font-semibold hover:text-blue-800 flex items-center bg-blue-50 px-3 py-2 rounded-md transition"><i class="fas fa-plus mr-2"></i> Add Another Item</button>
                </div>

                <div class="flex md:justify-end border-t pt-6">
                    <div class="w-full md:w-72 space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Subtotal:</span>
                            <span id="subtotalDisplay" class="font-semibold text-gray-800">₹0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Tax Amount:</span>
                            <input type="number" id="taxInput" name="tax" value="0" min="0" step="0.01" class="w-24 border-gray-300 rounded p-1.5 text-right focus:ring-blue-500" oninput="calculateGrandTotal()">
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold text-gray-900 border-t border-gray-200 pt-3 mt-2">
                            <span>Grand Total:</span>
                            <span id="grandTotalDisplay" class="text-blue-700">₹0.00</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg shadow-md hover:bg-blue-700 hover:shadow-lg transition">Generate Professional Invoice</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    window.currentPlanName = "";

    function calculateRow(element) {
        let row = element.closest('.item-row');
        let qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        let price = parseFloat(row.querySelector('.price-input').value) || 0;
        row.querySelector('.row-total').value = (qty * price).toFixed(2);
        calculateGrandTotal();
    }

    function calculateGrandTotal() {
        let subtotal = 0;
        document.querySelectorAll('.row-total').forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        document.getElementById('subtotalDisplay').innerText = "₹" + subtotal.toFixed(2);
        
        let tax = parseFloat(document.getElementById('taxInput').value) || 0;
        let grandTotal = subtotal + tax;
        document.getElementById('grandTotalDisplay').innerText = "₹" + grandTotal.toFixed(2);
    }

    function addRow(desc = "", price = 0) {
        let tbody = document.getElementById('itemsBody');
        let div = document.createElement('div');
        div.className = "item-row relative bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-lg border md:border-0 border-gray-200 grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-2 items-center";
        div.innerHTML = `
            <div class="md:col-span-5">
                <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Item Description</label>
                <input type="text" name="description[]" value="${desc}" required class="w-full border-gray-300 rounded md:p-1.5 p-2 shadow-sm md:shadow-none bg-white focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="grid grid-cols-3 gap-2 md:contents">
                <div class="md:col-span-2">
                    <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Qty</label>
                    <input type="number" name="quantity[]" value="1" min="1" class="w-full border-gray-300 rounded md:p-1.5 p-2 qty-input focus:ring-blue-500 bg-white" oninput="calculateRow(this)">
                </div>
                <div class="md:col-span-2">
                    <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Price (₹)</label>
                    <input type="number" name="price[]" value="${price}" step="0.01" class="w-full border-gray-300 rounded md:p-1.5 p-2 price-input focus:ring-blue-500 bg-white" oninput="calculateRow(this)">
                </div>
                <div class="md:col-span-2">
                    <label class="md:hidden text-xs text-gray-500 font-bold mb-1 block">Total (₹)</label>
                    <input type="text" readonly class="w-full bg-gray-200 md:bg-gray-100 border-transparent text-gray-800 font-semibold rounded md:p-1.5 p-2 row-total" value="${price.toFixed(2)}">
                </div>
            </div>
            <div class="md:col-span-1 absolute md:static top-2 right-2 md:text-center text-right">
                <button type="button" onclick="removeRow(this)" class="text-red-500 hover:text-red-700 bg-red-100 md:bg-transparent p-2 md:p-1 rounded-md transition"><i class="fas fa-trash"></i></button>
            </div>
        `;
        tbody.appendChild(div);
        calculateGrandTotal();
    }

    function removeRow(button) {
        let row = button.closest('.item-row');
        if (document.querySelectorAll('.item-row').length > 1) {
            row.remove();
            calculateGrandTotal();
        } else {
            alert("At least one item is required.");
        }
    }

    function toggleRechargeOptions() {
        let billFor = document.getElementById('billForSelect').value;
        let rechargeBox = document.getElementById('rechargePeriodBox');
        if (billFor === 'INTERNET RECHARGE') {
            rechargeBox.style.display = 'block';
        } else {
            rechargeBox.style.display = 'none';
        }
        updateFirstRow();
    }

    function updateFirstRow() {
        let billFor = document.getElementById('billForSelect').value;
        let firstRowDesc = document.querySelector('.item-row input[name="description[]"]');
        let firstRowQty = document.querySelector('.item-row .qty-input');
        
        let baseName = window.currentPlanName || "";
        
        if (billFor === 'INTERNET RECHARGE') {
            let fromVal = document.getElementById('period_from').value;
            let toVal = document.getElementById('period_to').value;
            
            if (fromVal && toVal) {
                let fromDate = new Date(fromVal + '-01');
                let toDate = new Date(toVal + '-01');
                
                let monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                let fromStr = monthNames[fromDate.getMonth()] + " " + fromDate.getFullYear().toString().slice(-2);
                let toStr = monthNames[toDate.getMonth()] + " " + toDate.getFullYear().toString().slice(-2);
                
                let months = (toDate.getFullYear() - fromDate.getFullYear()) * 12;
                months -= fromDate.getMonth();
                months += toDate.getMonth();
                months = months <= 0 ? 1 : months + 1;
                
                firstRowQty.value = months;
                firstRowDesc.value = (baseName ? baseName + " - " : "RECHARGE - ") + fromStr + " TO " + toStr;
                calculateRow(firstRowQty);
            } else if (baseName) {
                firstRowDesc.value = baseName;
            }
        } else {
            if (baseName) {
                firstRowDesc.value = baseName;
            }
        }
    }

    function addPlanToTable() {
        let select = document.getElementById('planSelect');
        let selected = select.options[select.selectedIndex];
        
        if (selected.value) {
            let price = parseFloat(selected.value);
            window.currentPlanName = selected.getAttribute('data-name');
            
            let firstRowPrice = document.querySelector('.item-row .price-input');
            firstRowPrice.value = price;
            
            updateFirstRow();
            calculateRow(firstRowPrice);
            select.value = ""; 
        }
    }

    window.onload = function() {
        toggleRechargeOptions();
    };
</script>
{% endblock %}